
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" 
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum VideoStatus {
  PENDING     
  PROCESSING  
  COMPLETED   
  FAILED      
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String
  role           Role      @default(USER)

  isVerified     Boolean   @default(false)
  otpCode        String?
  otpExpiresAt   DateTime?

  stripeCustomerId   String?   @unique 
  subscriptionId     String?   
  
  plan               String    @default("free") 
  planInterval       String?   
  
  subscriptionStatus String?   // "active", "canceled", "past_due"
  
  currentPeriodStart DateTime? // When they paid
  currentPeriodEnd   DateTime? // When it expires

  uploadedVideos Video[]       @relation("Uploader")
  watchHistory   WatchHistory[]
  views          View[]
  watchLists     WatchList[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}



model Video {
  id            String       @id @default(uuid())
  
  title         String?      @default("Untitled Video") 
  description   String?
  thumbnailUrl  String?

  videoUrl      String?      
  
  duration      Float?       
  views         Int          @default(0)
  category      String?      @default("General") 

  status        VideoStatus  @default(PENDING)

  uploaderId    String
  uploader      User         @relation("Uploader", fields: [uploaderId], references: [id])
  
  history       WatchHistory[]
  uniqueViews   View[]
  watchLists    WatchList[]


  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}


model WatchHistory {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  videoId   String
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  watchedAt DateTime @default(now())

  progress  Int      @default(0) // How many seconds watched? (e.g., 120s)
  duration  Int      @default(0) // Total length of video (e.g., 3600s)

  @@unique([userId, videoId]) 
}

model View {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  videoId   String
  video     Video    @relation(fields: [videoId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, videoId])
}

model WatchList {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  videoId   String
  video   Video @relation(fields: [videoId], references: [id], onDelete: Cascade)  
  addedAt   DateTime @default(now())

  @@unique([userId, videoId])
}